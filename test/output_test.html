<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <script src="../lib/prototype.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/plumb.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/column.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/letters.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/layout.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/output.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/recognition.js" type="text/javascript" charset="utf-8"></script>
    <style type="text/css" media="screen">
      
      .output {
        position: relative;
        padding-top: 10px;
        margin: 0 0 10px 0;
        width: 730px;
        background: #ddd;
      }
      
      .input {
        position: relative;
        width: 730px;
        background: #999;
        margin: 0 0 10px 0;
      }
      
      .output:after {
        content: ".";
        display: block;
        clear: both;
        visibility: hidden;
        line-height: 0;
        height: 0;
      }

      .output {
        display: inline-block;
      }

      html[xmlns] .output {
        display: block;
      }

      * html .output {
        height: 1%;
      }
      
      .output .container {
        margin-bottom: 10px;
      }
      
      .output .box {
        position: relative;
        height: 40px;
        margin-bottom: 10px;
        background: #000;
      }
      
      .input .box {
        position: absolute;
        background: #000;
      }
      
      .output .box.stretchy, .input .box.stretchy {
        background: #333;
      }
      
      #results {
        font-size: 150%;
        margin-bottom: 10px;
        width: 730px;
      }
      
      .fail {
        background: #f99;
      }
      
      .pass {
        background: #9f9;
      }
      
    </style>
  </head>
  <body>
    
    <div id="results">
    </div>
    
    <div id="output">
    </div>
    
    <script type="text/javascript" charset="utf-8">
    
      Plumb.setup({
        layout: { element: new Element('div'), width: 12 },
        output: { width: 50, margin: 10 }
      });
      
      var Cases = [
        [
          {"left": 0, "top": 10, "height": 40, "width": 12, "right": 11, "bottom": 50, "stretchy": true},
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": true},
          {"left": 6, "top": 60, "height": 40, "width": 6, "right": 11, "bottom": 100, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 6, "right": 5, "bottom": 50, "stretchy": true},
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": true},
          {"left": 6, "top": 10, "height": 90, "width": 6, "right": 11, "bottom": 100, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 90, "width": 6, "right": 5, "bottom": 100, "stretchy": true},
          {"left": 6, "top": 10, "height": 40, "width": 6, "right": 11, "bottom": 50, "stretchy": true},
          {"left": 6, "top": 60, "height": 40, "width": 6, "right": 11, "bottom": 100, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 9, "right": 8, "bottom": 50, "stretchy": true},
          {"left": 9, "top": 10, "height": 40, "width": 3, "right": 11, "bottom": 50, "stretchy": false},
          {"left": 0, "top": 60, "height": 40, "width": 12, "right": 11, "bottom": 100, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 6, "right": 5, "bottom": 50, "stretchy": true},
          {"left": 6, "top": 10, "height": 90, "width": 6, "right": 11, "bottom": 100, "stretchy": false},
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 12, "right": 11, "bottom": 50, "stretchy": true},
          {"left": 0, "top": 60, "height": 90, "width": 6, "right": 5, "bottom": 150, "stretchy": true},
          {"left": 6, "top": 60, "height": 40, "width": 6, "right": 11, "bottom": 100, "stretchy": true},
          {"left": 6, "top": 110, "height": 40, "width": 3, "right": 8, "bottom": 150, "stretchy": true},
          {"left": 9, "top": 110, "height": 40, "width": 3, "right": 11, "bottom": 150, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 12, "right": 11, "bottom": 50, "stretchy": true},
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": true},
          {"left": 0, "top": 110, "height": 40, "width": 3, "right": 2, "bottom": 150, "stretchy": true},
          {"left": 3, "top": 110, "height": 40, "width": 3, "right": 5, "bottom": 150, "stretchy": true},
          {"left": 6, "top": 60, "height": 90, "width": 6, "right": 11, "bottom": 150, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 12, "right": 11, "bottom": 50, "stretchy": true},
          {"left": 0, "top": 60, "height": 140, "width": 6, "right": 5, "bottom": 200, "stretchy": true},
          {"left": 6, "top": 60, "height": 40, "width": 6, "right": 11, "bottom": 100, "stretchy": true},
          {"left": 6, "top": 110, "height": 90, "width": 2, "right": 7, "bottom": 200, "stretchy": true},
          {"left": 8, "top": 110, "height": 40, "width": 4, "right": 11, "bottom": 150, "stretchy": true},
          {"left": 8, "top": 160, "height": 40, "width": 2, "right": 9, "bottom": 200, "stretchy": true},
          {"left": 10, "top": 160, "height": 40, "width": 2, "right": 11, "bottom": 200, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 12, "right": 11, "bottom": 50, "stretchy": true},
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": true},
          {"left": 0, "top": 110, "height": 90, "width": 2, "right": 1, "bottom": 200, "stretchy": true},
          {"left": 2, "top": 110, "height": 40, "width": 4, "right": 5, "bottom": 150, "stretchy": true},
          {"left": 2, "top": 160, "height": 40, "width": 2, "right": 3, "bottom": 200, "stretchy": true},
          {"left": 4, "top": 160, "height": 40, "width": 2, "right": 5, "bottom": 200, "stretchy": true},
          {"left": 6, "top": 60, "height": 140, "width": 6, "right": 11, "bottom": 200, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 4, "right": 3, "bottom": 50, "stretchy": true},
          {"left": 4, "top": 10, "height": 40, "width": 4, "right": 7, "bottom": 50, "stretchy": true},
          {"left": 8, "top": 10, "height": 40, "width": 4, "right": 11, "bottom": 50, "stretchy": true}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 2, "right": 1, "bottom": 50, "stretchy": true},
          {"left": 2, "top": 10, "height": 40, "width": 2, "right": 3, "bottom": 50, "stretchy": false},
          {"left": 4, "top": 10, "height": 40, "width": 2, "right": 5, "bottom": 50, "stretchy": true},
          {"left": 6, "top": 10, "height": 40, "width": 2, "right": 7, "bottom": 50, "stretchy": false},
          {"left": 8, "top": 10, "height": 40, "width": 2, "right": 9, "bottom": 50, "stretchy": true},
          {"left": 10, "top": 10, "height": 40, "width": 2, "right": 11, "bottom": 50, "stretchy": false}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 4, "right": 3, "bottom": 50, "stretchy": true},
          {"left": 4, "top": 10, "height": 40, "width": 4, "right": 7, "bottom": 50, "stretchy": true},
          {"left": 8, "top": 10, "height": 40, "width": 4, "right": 11, "bottom": 50, "stretchy": true},
          
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": true},
          {"left": 6, "top": 60, "height": 40, "width": 6, "right": 11, "bottom": 100, "stretchy": true},
          
          {"left": 0, "top": 110, "height": 40, "width": 12, "right": 11, "bottom": 150, "stretchy": true}
        ],
        
        [
          {"left": 3, "top": 10, "height": 40, "width": 3, "right": 5, "bottom": 50, "stretchy": false},
          {"left": 0, "top": 60, "height": 40, "width": 6, "right": 5, "bottom": 100, "stretchy": false}
        ],
        
        [
          {"left": 4, "top": 10, "height": 40, "width": 3, "right": 6, "bottom": 50, "stretchy": false},
          {"left": 1, "top": 60, "height": 40, "width": 6, "right": 6, "bottom": 100, "stretchy": false}
        ],
        
        [
          {"left": 9, "top": 10, "height": 40, "width": 3, "right": 11, "bottom": 50, "stretchy": false},
          {"left": 6, "top": 60, "height": 40, "width": 6, "right": 11, "bottom": 100, "stretchy": false}
        ],
        
        [
          {"left": 1, "top": 10, "height": 40, "width": 3, "right": 3, "bottom": 50, "stretchy": false},
          {"left": 5, "top": 10, "height": 40, "width": 3, "right": 7, "bottom": 50, "stretchy": false},
          {"left": 9, "top": 10, "height": 40, "width": 3, "right": 11, "bottom": 50, "stretchy": false}
        ],
        
        [
          {"left": 0, "top": 10, "height": 40, "width": 3, "right": 2, "bottom": 50, "stretchy": false},
          {"left": 4, "top": 10, "height": 40, "width": 3, "right": 6, "bottom": 50, "stretchy": false},
          {"left": 8, "top": 10, "height": 40, "width": 3, "right": 10, "bottom": 50, "stretchy": false}
        ]
      ];
      
      function generateInput(spec, container) {
        var O = Plumb.Output.options;
        
        spec.children.each(function(child) {
          if (child.children) {
            generateInput(child, container);
          } else {
            var box = new Element("div", { className: "box", id: child.id });
            
            if (child.stretchy)
              box.addClassName("stretchy");
            
            box.setStyle({
              top: child.top + "px",
              left: ((child.left * (O.width + O.margin)) + O.margin) + "px",
              width: ((((child.right - child.left) + 1) * (O.width + O.margin)) - O.margin) + "px",
              height: child.height + "px"
            });
            
            container.insert(box);
          }
        });
      }
      
      var passes = 0;
      
      Cases.each(function(c) {
        var spec = Plumb.Recognition.recognize(c);
        
        var pair = new Element("div", { className: "pair" });
        var input = new Element("div", { className: "input" });
        
        generateInput(spec, input);
        
        input.setStyle({
          height: input.select(".box").max(function(b) {
            return parseInt(Element.getStyle(b, "top")) + parseInt(Element.getStyle(b, "height")) + 10;
          }) + "px"
        });
        
        var out = new Element("div", { className: "output" });
        Plumb.Output.output(spec, out);
        
        pair.insert(input);
        pair.insert(out);
        
        $("output").insert(pair);
        
        var outOffset = out.cumulativeOffset();
        
        var measurements = $H();
        out.select(".box").each(function(b) {
          measurements.set(b.id, {
            left: b.cumulativeOffset().left - outOffset.left,
            width: b.getWidth()
          });
        });
        
        var pass = true;
        
        var inputOffset = input.cumulativeOffset();
        input.select(".box").each(function(b) {
          if (measurements.get(b.id).left != b.cumulativeOffset().left - inputOffset.left) {
            pass = false;
            throw $break;
          }
          
          if (measurements.get(b.id).width != b.getWidth()) {
            pass = false;
            throw $break;
          }
        });
      
        // only show failing tests
        if (pass) {
          out.addClassName("pass");
          passes += 1;
        } else {
          out.addClassName("fail");
        }
      });
      
      
      $("results").innerHTML = passes + " / " + Cases.length;
      
      if (passes == Cases.length)
        $("results").addClassName("pass");
      else
        $("results").addClassName("fail");
      
    </script>
    
  </body>
</html>