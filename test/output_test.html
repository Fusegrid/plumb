<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="test.css" type="text/css" media="screen" charset="utf-8">
    <script src="../lib/prototype.js" type="text/javascript" charset="utf-8"></script>
    <script src="lib/unittest.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/plumb.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/recognition.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/layout.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/column.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/output.js" type="text/javascript" charset="utf-8"></script>
    <style type="text/css" media="screen">
      
      #arena {
        background: #f00;
      }
      
      #arena .shape {
        background: #999;
        color: #fff;
      }
      
    </style>
  </head>
  <body>
    
    <div id="arena">
    </div>
    
    <div id="testlog">
    </div>
    
    <script type="text/javascript" charset="utf-8">
    
      Plumb.setup({
        layout: { element: new Element('div'), width: 12 },
        output: { width: 25, margin: 5 }
      });
      
      Object.extend(Test.Unit.Testcase.prototype, {
        assertStyles: function(expected, element) {
          element = $(element);
          
          $H(expected).each(function(p) {
            this.assertEqual(p.value, element.getStyle(p.key), p.key);
            if (p.value != element.getStyle(p.key))
              console.log(element);
          }.bind(this));
        }
      });
      
      Fixtures = {
        // |--a--| |------------------b------------------|
        twoPlainColumns: {
          id: 'ab',
          root: true,
          type: "columns",
          width: 12,
          children: [
            { id: 'a', width: 2 },
            { id: 'b', width: 10 }
          ]
        },
        
        // |--a--| |------------------b------------------|
        // |-----| 
        // |-----| |--------c--------| |--------d--------|
        //
        // |----------------------e----------------------|
        nestedRowsAndColumns: {
          id: 'abcde',
          root: true,
          type: "rows",
          width: 12,
          children: [
            {
              id: 'abcd',
              root: false,
              type: "columns",
              width: 12,
              children: [
                { id: 'a', width: 2 },
                {
                  id: 'bcd',
                  root: false,
                  type: "rows",
                  width: 10,
                  children: [
                    { id: 'b', width: 10 },
                    {
                      id: 'cd',
                      root: false,
                      type: "columns",
                      width: 10,
                      children: [
                        { id: 'c', width: 5 },
                        { id: 'd', width: 5 }
                      ]
                    }
                  ]
                }
              ]
            },
            { id: 'e', width: 12 }
          ]
        },
        
        // |--a--| |<-----------------b----------------->|
        stretchyColumn: {
          id: 'ab',
          root: true,
          type: "columns",
          width: { percentage: 100, subtrahend: 0 },
          children: [
            { id: 'a', width: 2 },
            { id: 'b', width: { percentage: 100, subtrahend: 2 } }
          ]
        },
      }
      
      new Test.Unit.Runner({
        setup: function() {
          $("arena").innerHTML = "";
        },
        
        testTwoPlainColumns: function() {
          var element = Plumb.Output.elementForContainer(Fixtures.twoPlainColumns);
          element.select('.shape').invoke("insert", "Lorem ipsum dolor sit amet");
          $("arena").insert(element);
          
          this.assertStyles({ 'width': "365px", 'float': 'none' }, 'ab');
          
          this.assertStyles({ 'marginLeft': "5px", 'width': "55px", 'float': 'left' }, 'a');
          this.assertStyles({ 'marginLeft': "5px", 'width': "295px", 'float': 'left' }, 'b');
        },
        
        testNestedRowsAndColumns: function() {
          var element = Plumb.Output.elementForContainer(Fixtures.nestedRowsAndColumns);
          element.select('.shape').invoke("insert", "Lorem ipsum dolor sit amet");
          $("arena").insert(element);
          
          this.assertStyles({ 'width': "365px", 'float': 'none' }, 'abcde');
          
          this.assertStyles({ 'width': "365px", 'float': 'none' }, 'abcd');
          this.assertStyles({ 'width': "355px", 'marginLeft': "5px", 'float': 'none' }, 'e');
          
          this.assertStyles({ 'width': "55px", 'marginLeft': "5px", 'float': 'left' }, 'a');
          this.assertStyles({ 'width': "305px", 'float': 'left' }, 'bcd');
          
          this.assertStyles({ 'width': "295px", 'marginLeft': "5px", 'float': 'none' }, 'b');
          this.assertStyles({ 'width': "305px", 'float': 'none' }, 'cd');
          
          this.assertStyles({ 'width': "145px", 'marginLeft': "5px", 'float': 'left' }, 'c');
          this.assertStyles({ 'width': "145px", 'marginLeft': "5px", 'float': 'left' }, 'd');
        },
                        
        testStretchyColumn: function() {
          var element = Plumb.Output.elementForContainer(Fixtures.stretchyColumn);
          $("arena").insert(element);
          
          element.select('.shape').invoke("insert", "Lorem ipsum dolor sit amet");
          
          console.log($("arena").innerHTML);
          
          $("arena").setStyle({ 'width': "365px" });
          this.assertEqual(295, $("b").offsetWidth);
          
          $("arena").setStyle({ 'width': "375px" });
          this.assertEqual(305, $("b").offsetWidth);
          
          $("arena").setStyle({ 'width': "385px" });
          this.assertEqual(315, $("b").offsetWidth);
        }
      });
      
    </script>
    
  </body>
</html>