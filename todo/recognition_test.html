<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="test.css" type="text/css" media="screen" charset="utf-8">
    <script src="../lib/prototype.js" type="text/javascript" charset="utf-8"></script>
    <script src="../lib/unittest.js" type="text/javascript" charset="utf-8"></script>
    <script src="../src/container.js" type="text/javascript" charset="utf-8"></script>
  </head>
  <body>
    
    <div id="testlog">
    </div>
    
    <div id="console">
    </div>
    
    <script type="text/javascript" charset="utf-8">
      
      Fixtures = {
        // |-a-|     |-b-|
        //
        // |------c------|
        simpleHorizontal: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 20 },
          { id: "b", top: 10, left: 30, right: 40, bottom: 20 },
          { id: "c", top: 30, left: 10, right: 40, bottom: 40 }
        ],
        
        simpleHorizontalJumbled: [
          { id: "b", top: 10, left: 30, right: 40, bottom: 20 },
          { id: "c", top: 30, left: 10, right: 40, bottom: 40 },
          { id: "a", top: 10, left: 10, right: 20, bottom: 20 }
        ],
        
        simpleHorizontalUneven: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 20 },
          { id: "b", top: 9, left: 30, right: 40, bottom: 19 },
          { id: "c", top: 30, left: 10, right: 40, bottom: 40 }
        ],
        
        simpleHorizontalMoreUneven: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 20 },
          { id: "b", top: 9, left: 30, right: 40, bottom: 19 },
          { id: "c", top: 30, left: 9, right: 39, bottom: 40 }
        ],
        
        // |-a-|     |-b-|
        // |---| 
        // |---|     |-c-|
        simpleVertical: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 40},
          { id: "b", top: 10, left: 30, right: 40, bottom: 20},
          { id: "c", top: 30, left: 30, right: 40, bottom: 40}
        ],
        
        // |-a-|
        // |---|     |-b-| 
        // |---| 
        // |---|     |-c-| 
        // |---|
        squashedSimpleVertical: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 60},
          { id: "b", top: 20, left: 30, right: 40, bottom: 30},
          { id: "c", top: 40, left: 30, right: 40, bottom: 50}
        ],
        
        jumbledSquashedSimpleVertical: [
          { id: "b", top: 20, left: 30, right: 40, bottom: 30},
          { id: "a", top: 10, left: 10, right: 20, bottom: 60},
          { id: "c", top: 40, left: 30, right: 40, bottom: 50}
        ],
        
        anotherJumbledSquashedSimpleVertical: [
          { id: "c", top: 40, left: 30, right: 40, bottom: 50},
          { id: "b", top: 20, left: 30, right: 40, bottom: 30},
          { id: "a", top: 10, left: 10, right: 20, bottom: 60}
        ],
        
        // |-a-|
        //
        // |----b---|
        //
        // |------c------|
        series: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 20},
          { id: "b", top: 30, left: 10, right: 30, bottom: 40},
          { id: "c", top: 50, left: 10, right: 40, bottom: 60}
        ],
        
        jumbledSeries: [
          { id: "b", top: 30, left: 10, right: 30, bottom: 40},
          { id: "c", top: 50, left: 10, right: 40, bottom: 60},
          { id: "a", top: 10, left: 10, right: 20, bottom: 20}
        ],
        
        // |-a-|     |-b-|     |-c-|
        // |---| 
        // |---|     |------d------|
        //
        // |-----------e-----------|
        slightlyMoreComplicated: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 40},
          { id: "b", top: 10, left: 30, right: 40, bottom: 20},
          { id: "c", top: 10, left: 50, right: 60, bottom: 20},
          { id: "d", top: 30, left: 30, right: 60, bottom: 40},
          { id: "e", top: 50, left: 10, right: 60, bottom: 60}
        ],
        
        // |-a-|     |-b-|     |-c-|     |-e-|     |-f-|
        // |---|                         |---|     |---|
        // |---|     |------d------|     |---|     |---|
        fourMainColumns: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 40},
          { id: "b", top: 10, left: 30, right: 40, bottom: 20},
          { id: "c", top: 10, left: 50, right: 60, bottom: 20},
          { id: "d", top: 30, left: 30, right: 60, bottom: 40},
          { id: "e", top: 10, left: 70, right: 80, bottom: 40},
          { id: "f", top: 10, left: 90, right: 100, bottom: 40}
        ],
        
        // |-a-|     |------b-----|
        // |---|     
        // |---|              |-c-|
        // |---|              |---|
        //                    |---|
        // |------d------|    |---|
        unsupported: [
          { id: "a", top: 10, left: 10, right: 20, bottom: 50 },
          { id: "b", top: 10, left: 30, right: 60, bottom: 20 },
          { id: "c", top: 60, left: 10, right: 40, bottom: 70 },
          { id: "d", top: 30, left: 50, right: 60, bottom: 70 }
        ]
      }
      
      Test.context("Recognition", {
        "should accumulate shapes (with fourMainColumns fixture)": function() {
          var row, column;
          
          row = Fixtures.fourMainColumns;
          column = Container.accumulateShapes(row, 'columns');
          column.length.shouldEqual(1);
          assert(column.pluck("id").include("a"));
          
          row = row.without.apply(row, column);
          column = Container.accumulateShapes(row, 'columns');
          column.length.shouldEqual(3);
          assert(column.pluck("id").include("b"));
          assert(column.pluck("id").include("c"));
          assert(column.pluck("id").include("d"));
          
          row = row.without.apply(row, column);
          column = Container.accumulateShapes(row, 'columns');
          column.length.shouldEqual(1);
          assert(column.pluck("id").include("e"));
          
          row = row.without.apply(row, column);
          column = Container.accumulateShapes(row, 'columns');
          column.length.shouldEqual(1);
          assert(column.pluck("id").include("f"));
        },
        
        "should accumulate shapes (with jumbledSquashedSimpleVertical fixture)": function() {
          var accumulated = Container.accumulateShapes(Fixtures.jumbledSquashedSimpleVertical, 'rows');
          accumulated.length.shouldEqual(3);
          assert(accumulated.pluck("id").include("a"), "doesn't include a");
          assert(accumulated.pluck("id").include("b"), "doesn't include b");
          assert(accumulated.pluck("id").include("c"), "doesn't include c");
        },
        
        "should sort shapes correctly": function() {
          var sorted;
          
          sorted = Container.sortShapes([
            { id: "a", top: 10, left: 10, right: 20, bottom: 20 },
            { id: "b", top: 5, left: 30, right: 40, bottom: 15 }
          ], 'columns');
          sorted.pluck("id").shouldEqualEnum($w("a b"));
          
          sorted = Container.sortShapes([
            { id: "a", top: 10, left: 10, right: 20, bottom: 20},
            { id: "b", top: 30, left: 5, right: 15, bottom: 40}
          ], 'rows');
          sorted.pluck("id").shouldEqualEnum($w("a b"));
        },
        
        "should recognize various configurations of a simple layout": function() {
          var checkLayout = function(c) {
            c.children[0].children[0].id.shouldEqual("a");
            c.children[0].children[1].id.shouldEqual("b");
            c.children[1].id.shouldEqual("c");
          }.bind(this);
          
          checkLayout(new Container(Fixtures.simpleHorizontal));
          checkLayout(new Container(Fixtures.simpleHorizontalJumbled));
          checkLayout(new Container(Fixtures.simpleHorizontalUneven));
          checkLayout(new Container(Fixtures.simpleHorizontalMoreUneven));
        },
        
        "should recognize another simple layout": function() {
          var container = new Container(Fixtures.simpleVertical);
          
          container.children[0].id.shouldEqual("a");
          container.children[1].children[0].id.shouldEqual("b");
          container.children[1].children[1].id.shouldEqual("c");
        },
        
        "should recognize the squashed simple vertical layout": function() {
          var checkLayout = function(c) {
            c.type.shouldEqual("columns");
            c.children[0].id.shouldEqual("a");
            c.children[1].type.shouldEqual("rows");
            c.children[1].children[0].id.shouldEqual("b");
            c.children[1].children[1].id.shouldEqual("c");
          }.bind(this)
            
          checkLayout(new Container(Fixtures.squashedSimpleVertical));
          checkLayout(new Container(Fixtures.jumbledSquashedSimpleVertical));
          checkLayout(new Container(Fixtures.anotherJumbledSquashedSimpleVertical));
        },
        
        "should recognize the series layout": function() {
          var checkLayout = function(c) {
            c.type.shouldEqual("rows");
            c.children[0].id.shouldEqual("a");
            c.children[1].id.shouldEqual("b");
            c.children[2].id.shouldEqual("c");
          }.bind(this)
            
          checkLayout(new Container(Fixtures.series));
          checkLayout(new Container(Fixtures.jumbledSeries));
        },
        
        "should recognize a slightly more complicated layout": function() {
          var container = new Container(Fixtures.slightlyMoreComplicated);
          
          container.children[0].children[0].id.shouldEqual("a");
          container.children[0].children[1].children[0].children[0].id.shouldEqual("b");
          container.children[0].children[1].children[0].children[1].id.shouldEqual("c");
          container.children[0].children[1].children[1].id.shouldEqual("d");
          container.children[1].id.shouldEqual("e");
        },
        
        "should recognize an unsupported layout": function() {
          assertRaise("UnsupportedLayout", function() {
            new Container(Fixtures.unsupported);
          });
        }
      });
      
    </script>
    
  </body>
</html>